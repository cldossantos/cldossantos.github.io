{
  "hash": "e5c6c8a95851d27d691c0c52caf5d47d",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Processing as-applied and as-planted data in on-farm trials\"\nauthor: \"Caio dos Santos\"\ndate: \"2025-07-19\"\ncategories: [pacu, yield monitor]\n---\n\n\n\n## Introduction\n\nIn the context of on-farm research, we often apply treatments using variable rate\napplicators to investigate how these different treatments will affect crop yield. An important piece of extracting treatment effects is to process the \"as-applied\" or \"as-planted\" data, in the cases of fertilizer and planting data, respectively. \n\nWe have just released a new function called **pa_trial**, to process these data. The function can help us process as-applied data and aggregate these data at the level of experimental unit, so we can model the yield response to treatment.\n\nThe **pa_trial** function is still experimental, and we are still testing it and making sure that the function arguments are intuitive for general use. These might change in the development version but, when we release a final version to CRAN, these will be set. If you use the package and find any issues with the **pa_trial** function, please [report it](https://github.com/cldossantos/pacu/issues) to us so we can fix it.\n\n\n\n## Installing the necessary packages \n\nThe **pa_trial** function can be found in the development version of **pacu** on GitHub. We will use two libraries for this example, [pacu](https://github.com/cldossantos/pacu) and [sf](https://github.com/r-spatial/sf). In case you do not have them installed, you can install them using the following code chunk\n\n\n::: {.cell}\n\n```{.r .cell-code}\ninstall.packages('sf')\n\n## we will install pacu from GitHub because of some newly added features\n## version 0.1.70\nremotes::install_github('cldossantos/pacu')\n```\n:::\n\n\n\nLet's load the libraries:\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(sf)\nlibrary(pacu)\n```\n:::\n\n\n\n\n\n\n## Reading the data in\n\nFor this example, we will use three simulated data sets that were built for this example. These data simulate a maize on-farm experiment that had both nitrogen and seeding rate treatments. In this particular case, I simulated an existing relationship between yield and nitrogen, but no relationship between yield and seeding rate. Let's see if we can recover these relationships!\n\n\nHere, all the raw data that we will use in this example:\n\n1. Trial design: This data set contains the geometries and prescriptions for nitrogen and seeding rates\n1. As-planted: This data set comes from the planter's monitor and shows what was the planted population at each data point\n1. As-applied nitrogen: This data set comes from the variable rate applicator and contains the applied nitrogen rate at each data point\n1. Raw yield: Data from the yield monitor showing the yield registered at each\ndata point\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntrial.design <- st_read('./raw-data/trial-design.shp')\nplanted.seed <- st_read('./raw-data/as-planted.shp')\napplied.n <- st_read('./raw-data/as-applied-nitrogen.shp')\nraw.yield <- st_read('./raw-data/synthetic-raw-yield.shp')\n```\n:::\n\n\n\n\n## Taking a first look at the data\n\n### As-planted\n\nLet's take a look at the planter's data, which shows the seeding rate at each point. To facilitate visualization, let's include the trial design grid as well. \n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nplot(planted.seed['plant_pop_'], \n     main = 'Seeding density (k seeds/ac)',\n     cex = 0.5,\n     pch = 16,\n     reset = FALSE)\nplot(st_geometry(trial.design), add = TRUE)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-4-1.png){width=672}\n:::\n:::\n\n\n\n\n\n### As-applied nitrogen\n\nLet's take a look at the variable rate applicator's data. This data shows how much urea was applied at each data point.  \n\n\n::: {.cell}\n\n```{.r .cell-code}\nplot(applied.n['appliedrt'], \n     main = 'Applied Urea (lb/ac)',\n     cex = 0.5,\n     pch = 16,\n     reset = FALSE)\nplot(st_geometry(trial.design), add = TRUE)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-5-1.png){width=672}\n:::\n:::\n\n\n\n\n### Raw yield\n\nLet's take a look at the yield monitor's data. This will tell us what was the yield at each data point. \n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nplot(raw.yield['Yield'], \n     main = 'Maize yield (bu/ac)',\n     cex = 0.3,\n     pch = 16,\n     reset = FALSE)\n\nplot(st_geometry(trial.design), add = TRUE)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-6-1.png){width=672}\n:::\n:::\n\n\n\n\n\n## Bringing these datasets together\n\nNow that we have seen each data set separately, we need to bring these data sets together so we can investigate the relationship between our imposed treatments and yield. To do that, we will process both the variable rate and the planter data using **pa_trial**, and then we will process the yield monitor data using **pa_trial**. For all the next steps, we will use the **ritas** algorithm. You can find more information about how we implemented this algorithm in the original publication of [pacu](https://doi.org/10.1016/j.softx.2024.101971).\n\n\nBefore we process these data, I will remove the big bordering area around our experimental plots just to reduce the amount of data we will process. This can be done before or after processing the data but doing it before, saves you some processing time.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntrial.design <- subset(trial.design, type == 'Trial')\nplot(st_geometry(trial.design))\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-7-1.png){width=672}\n:::\n:::\n\n\n\n\n\n### As-planted\n\nHere, we will use **pa_trial** to process the as-planted data. The function requires the user to specify which column in the input data set corresponds to the \"trial\" column. In this case, the seeding density is in a column called ***plant_pop_***. I am also specifying that the units of the planter's width are \"ft\".  I use a conversion factor of 2.47 to convert from acre to hectare as well. \n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nprocessed.seed <- pa_trial(planted.seed,\n                           data.columns = c(trial = 'plant_pop_'),\n                           data.units = c(trial = 'k seeds/ac',\n                                          width = 'ft'),\n                           grid = trial.design,\n                           algorithm = 'ritas',\n                           var.label = 'seeds',\n                           conversion.factor = 2.47,\n                           out.units = 'k seeds/ha',\n                           verbose = FALSE, ## suppressing progress bar\n                           cores = 6) ## for speed\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nGuessing units of angle to be degreeN\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nGuessing units of distance to be ft\n```\n\n\n:::\n:::\n\n\n\nUsing **pa_trial**, we aggregated the seed data at the level of experimental unit, as can be seen below.\n\n\n::: {.cell}\n\n```{.r .cell-code}\npa_plot(processed.seed)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-9-1.png){width=672}\n:::\n:::\n\n\n\n\n\n### As-applied nitrogen\n\nHere, we will follow the same process that we used to process the seeding density data set. The one difference is that the conversion factors change. Since the nitrogen data is as urea, we will use a conversion factor of 0.45 to reflect the  nitrogen content in the urea, and then 1.12 to convert from $lb.ac^{-1}$ to $kg.ha^{-1}$.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nprocessed.nitrogen <- pa_trial(applied.n,\n                               data.columns = c(trial = 'appliedrt'),\n                               data.units = c(trial = 'lb Urea/ac',\n                                              width = 'ft'),\n                               grid = trial.design,\n                               algorithm = 'ritas',\n                               var.label = 'nitrogen',\n                               conversion.factor = 0.45 * 1.12,\n                               out.units = 'kg N/ha',\n                               verbose = 0,\n                               cores = 6)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nGuessing units of angle to be degreeN\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nGuessing units of distance to be ft\n```\n\n\n:::\n:::\n\n\n\nUsing **pa_trial**, we aggregated the nitrogen data at the level of experimental unit, as can be seen below.\n\n\n::: {.cell}\n\n```{.r .cell-code}\npa_plot(processed.nitrogen)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-11-1.png){width=672}\n:::\n:::\n\n\n\n\n### Merging the treatment datasets\n\nNow that both treatment data sets are processed, we can combine them into a single object. \n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntreatments <- merge(processed.nitrogen, processed.seed)\nprint(treatments)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nVariables in trial object:\n------------------------------------------\nVariable  Algorithm  Smoothing  Units      \n---       ---        ---        ---        \nnitrogen  ritas      none       kg N/ha    \nseeds     ritas      none       k seeds/ha \n------------------------------------------\n\nVariable summary:\n------------------------\n         nitrogen  seeds \n---      ---       ---   \nMin.     59.315087 71.610\n1st Qt.  83.723312 80.764\nMedian   109.88047 86.883\n3rd Qt.  132.25985 93.063\nMax.     160.26292 101.50\nMean     108.21485 87.039\nNAs      0         0     \n------------------------\n```\n\n\n:::\n\n```{.r .cell-code}\npa_plot(treatments)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-12-1.png){width=672}\n:::\n:::\n\n\n\n\n### Yield monitor data\n\nAfter processing all the treatment data, we can pass the **treatments** object to the \"grid\" argument and the resulting object will contain all the information regarding treatments and yield. The **pa_yield** function will try to guess the units of the variables it uses to process the yield monitor data. Pay attention to these and, in case they are not correct, you can override the guess by passing the argument \"data.units\".\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nprocessed.yield <- pa_yield(raw.yield,\n                            grid = treatments,\n                            algorithm = 'ritas',\n                            formula = z ~ fid,\n                            smooth.method = 'krige',\n                            unit.system = 'metric',\n                            remove.crossed.polygons = TRUE,\n                            steps = TRUE,\n                            verbose = FALSE,\n                            cores = 6)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nGuessing units of interval to be s\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nGuessing units of moisture to be %\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nGuessing units of flow to be lb/s\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nGuessing units of angle to be degreeN\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nGuessing units of width to be ft\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nGuessing units of distance to be ft\n```\n\n\n:::\n:::\n\n\n\nWe can see the processed yield data below\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\npa_plot(processed.yield)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-14-1.png){width=672}\n:::\n:::\n\n\n\n\n\n## Looking at the relationships between yield and the treatment variables\n\nBelow, we can examine the relationship between yield and both treatment variables: nitrogen and seeding rate. The next steps are really independent from **pacu**. One can choose to model these data using whatever modeling framework they are most comfortable with, or judge the most adequate. Since the idea of this post is to demonstrate how **pacu** can aid in analyzing on-farm experimental data, I will stop here.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nwith(processed.yield$yield, \n     plot(nitrogen, \n          yield, \n          col = 4,\n          xlab = 'Nitrogen rate (kg N/ha)',\n          ylab = 'Yield (t/ha)'))\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-15-1.png){width=672}\n:::\n\n```{.r .cell-code}\nwith(processed.yield$yield, \n     plot(seeds, \n          yield, \n          col = 4,\n          xlab = 'Seeding rate (k seeds/ha)',\n          ylab = 'Yield (t/ha)'))\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-15-2.png){width=672}\n:::\n:::\n\n\n\n\n## Conclusion\n\nIn this post we saw how the new **pa_trial** function can be used to process as-applied data from variable rate technologies in on-farm trials. We showed how to aggregate planting and nitrogen application data to the level of the experimental unit and combine them with yield monitor data for further analysis.\n\nBy doing so, we can move beyond simply knowing what was intended in an experimental design to understanding what was actually applied in the field—an important distinction when modeling treatment effects in precision agriculture.\n\nIf you have to process some of these data, you should definitely give **pacu** a try and let me know how it goes! We'll be back with more updates on **pacu** soon! Stay tuned! \n\n\n\n\n",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}